<div class="container py-4">
  <div class="title">Participants</div>

  <div class="form-card-1">
    <div class="row g-4 mb-3">
      <div class="col-md-6">
        <label for="installmentFilter" class="form-label fw-bold">Installment</label>
        <select class="form-select" [(ngModel)]="modalInstallmentId" (change)="filterModalParticipants()"
          id="installmentFilter">
          <option value="">All Installments</option>
          <option *ngFor="let i of modalInstallments" [value]="i?.id">{{ i?.name }}</option>
        </select>
      </div>
      <div class="col-md-6">
        <label for="modalSearch" class="form-label fw-bold">Search Students</label>
        <input type="text" class="form-control" id="modalSearch" placeholder="Name or email address..."
          [(ngModel)]="modalSearchTerm" (input)="filterModalParticipants()" />
      </div>
    </div>
  </div>

  <div class="warning-msg" *ngIf="!modalInstallmentId">
    <div class="d-flex align-items-center gap-3">
      <i class="material-icons">info_outline</i>
      <p class="m-0">Tip: Choose a specific course and installment to management students more effectively.</p>
    </div>
  </div>

  <div class="table-card-1 shadow-soft">
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Student Name</th>
            <th class="text-center">Payment</th>
            <th class="d-none d-md-table-cell">Installment</th>
            <th>Email</th>
            <th class="text-center">Status</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let p of filteredModalParticipants | paginate: { itemsPerPage: 5, currentPage: currentParticipantsPage, id: 'paginationEnrolls' }">
            <td>
              <div class="d-flex align-items-center gap-3">
                <div class="avatar-small">
                  {{ p.name.charAt(0) }}</div>
                <span>{{ p.name }}</span>
              </div>
            </td>
            <td>
              <select class="form-select text-white" [(ngModel)]="p.pStatus" [ngModelOptions]="{ standalone: true }"
                [ngStyle]="{'background-color': p.pStatus === 'paid' ? '#10b981' : p.pStatus === 'unpaid' ? '#ef4444' : '#f59e0b'}"
                (change)="updatePaymentStatus(p.id, p.courseId, p.installmentId, p.pStatus)">
                <option *ngFor="let ps of paidStatus" [value]="ps.value">{{ ps.name }}</option>
              </select>
            </td>
            <td class="d-none d-md-table-cell"><code class="text-primary font-monospace">{{ p.installmentId }}</code>
            </td>
            <td><span class="text-muted">{{ p.email }}</span></td>
            <td>
              <select class="form-select text-white" [(ngModel)]="p.aStatus" [ngModelOptions]="{ standalone: true }"
                [ngStyle]="{'background-color': p.aStatus === 'enrolled' ? '#10b981' : p.aStatus === 'dropped' ? '#ef4444' : '#f59e0b'}"
                (change)="updateAccountStatus(p.id, p.courseId, p.aStatus)">
                <option *ngFor="let pa of accountStatus" [value]="pa.value">{{ pa.name }}</option>
              </select>
            </td>
            <td class="text-end">
              <button class="btn-outline btn-o-1 py-1 px-3" (click)="viewParticipant(p)" title="View Profile">
                <i class="material-icons" style="font-size: 18px">visibility</i>
              </button>
            </td>
          </tr>
          <tr *ngIf="filteredModalParticipants.length === 0">
            <td colspan="6" class="text-center py-5">
              <p class="text-muted m-0">No students found matching your criteria.</p>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="6" class="text-center border-0 p-0">
              <pagination-controls class="pagination" id="paginationEnrolls" [maxSize]="5" [directionLinks]="false"
                (pageChange)="currentParticipantsPage = $event">
              </pagination-controls>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <button id="participantProfileBtn" type="button" class="d-none" data-bs-toggle="modal"
    data-bs-target="#participantProfile"></button>
  <div class="modal fade" id="participantProfile" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ selectedParticipant?.name }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>Email:</strong> {{ selectedParticipant?.email }}</p>
          <p><strong>Status:</strong> {{ selectedParticipant?.aStatus }}</p>
          <p><strong>Payment:</strong> {{ selectedParticipant?.pStatus }}</p>
          <p><strong>Installment:</strong> {{ selectedParticipant?.installmentId ?? 'N/A' }}</p>
        </div>
      </div>
    </div>
  </div>
</div>